# GitHub Copilot - Entwicklungs-Richtlinien

## ğŸ¯ Projekt-Kontext

**Rechnungsverwaltungssystem** - GoBD-konforme Rechnungsstellung fÃ¼r kleine
Unternehmen und Imker.

**GeschÃ¤ftsmodell:**

- Direktverkauf (Endkunden): Normale Rechnungen
- WiederverkÃ¤ufer: Lieferscheine + Kommissionsware
- Markt/Hausverkauf: POS-System (Kasse)
- Steuern: Â§24 UStG fÃ¼r landwirtschaftliche Urproduktion (z.B. Honig: 7,8%)

**Stack:**

- Backend: Flask 3.0 + SQLAlchemy + PostgreSQL
- Frontend: Vanilla HTML/CSS/JavaScript (kein Framework)
- PDF: ReportLab
- Auth: Flask-Login + 2FA (pyotp)
- API: JWT-Tokens fÃ¼r PWA

______________________________________________________________________

## ğŸ“ Projektstruktur

```
rechnungen/
â”œâ”€â”€ app.py                      # Flask-App, alle Routes
â”œâ”€â”€ models.py                   # SQLAlchemy-Modelle
â”œâ”€â”€ config.py                   # Konfiguration (Firma, Steuern, Token)
â”œâ”€â”€ email_service.py            # Flask-Mail Setup
â”œâ”€â”€ .env                        # Secrets (NICHT committen!)
â”œâ”€â”€ requirements.txt            # Python-Dependencies
â”œâ”€â”€ GOBD_COMPLIANCE.md          # GoBD-Verfahrensdokumentation
â”œâ”€â”€ .copilot-instructions.md    # Diese Datei
â”œâ”€â”€ .gitignore                  # Git-Ignore-Rules
â”‚
â”œâ”€â”€ templates/                  # Jinja2-Templates
â”‚   â”œâ”€â”€ base.html              # Base-Template (Navigation, User-Info)
â”‚   â”œâ”€â”€ index.html             # Dashboard
â”‚   â”œâ”€â”€ auth/                  # Login, 2FA
â”‚   â”‚   â”œâ”€â”€ login.html
â”‚   â”‚   â””â”€â”€ verify_2fa.html
â”‚   â”œâ”€â”€ invoices/              # Rechnungen
â”‚   â”‚   â”œâ”€â”€ list.html
â”‚   â”‚   â”œâ”€â”€ create.html
â”‚   â”‚   â”œâ”€â”€ edit.html
â”‚   â”‚   â”œâ”€â”€ view.html
â”‚   â”‚   â””â”€â”€ create_cancellation.html
â”‚   â”œâ”€â”€ customers/             # Kunden
â”‚   â”œâ”€â”€ products/              # Produkte
â”‚   â”œâ”€â”€ delivery_notes/        # Lieferscheine
â”‚   â””â”€â”€ pos.html               # Kasse (POS)
â”‚
â”œâ”€â”€ migrations/                # Datenbank-Migrationen
â”‚   â”œâ”€â”€ create_users_table.py
â”‚   â”œâ”€â”€ migrate_add_gobd_tables.py
â”‚   â””â”€â”€ regenerate_hashes.py
â”‚
â”œâ”€â”€ pdfs/                      # Generierte PDFs (GoBD-archiviert)
â”œâ”€â”€ uploads/                   # Upload-Ordner
â””â”€â”€ static/                    # CSS, JS, Bilder (falls vorhanden)
```

______________________________________________________________________

## ğŸ—„ï¸ Datenbank-Schema

### Kern-EntitÃ¤ten

**User** (Authentifizierung)

- `id`, `username`, `email`, `password_hash`
- `role`: 'admin', 'cashier', 'reseller'
- `totp_secret`, `totp_enabled`, `backup_codes` (2FA)
- `api_token`, `api_token_expires` (PWA)
- `reseller_customer_id` (FK zu Customer, nur fÃ¼r role='reseller')

**Customer** (Kunden)

- `id`, `company_name`, `first_name`, `last_name`
- `email`, `phone`, `address`, `tax_id`

**Product** (Produkte)

- `id`, `name`, `quantity` (z.B. "500g"), `number` (Bestand)
- `price` (Endkunde), `reseller_price` (WiederverkÃ¤ufer)
- `tax_rate` (produktspezifisch, z.B. 7.8 fÃ¼r Honig)
- `lot_number`, `active`

**Invoice** (Rechnungen) - **KRITISCH fÃ¼r GoBD!**

- `id`, `invoice_number` (z.B. "RE-2024-11-08-0001", "STORNO-...", "BAR-...")
- `customer_id` (FK), `invoice_date`, `due_date`
- `status`: 'draft', 'sent', 'paid', 'cancelled'
- `subtotal`, `tax_rate`, `tax_amount`, `total`
- `tax_model`: 'standard', 'kleinunternehmer', 'landwirtschaft'
- `customer_type`: 'endkunde', 'wiederverkaeufer'
- `data_hash` (SHA-256, NOT NULL) - **Manipulationsschutz!**
- `notes`, `payment_method`

**LineItem** (Rechnungspositionen)

- `id`, `invoice_id` (FK), `product_id` (FK, optional)
- `description`, `quantity`, `unit_price`, `total`
- `tax_rate` (produktspezifisch)
- `position` (Sortierung)

**InvoiceStatusLog** (Audit-Trail) - **GoBD!**

- `id`, `invoice_id` (FK)
- `old_status`, `new_status`
- `changed_at`, `changed_by` (username!), `reason`

**InvoicePdfArchive** (PDF-Hashes) - **GoBD!**

- `id`, `invoice_id` (FK)
- `pdf_filename`, `pdf_hash` (SHA-256), `file_size`
- `created_at`, `archived_by` (username!)

### WiederverkÃ¤ufer-System

**DeliveryNote** (Lieferscheine)

- `id`, `delivery_note_number`, `customer_id` (FK)
- `delivery_date`, `status` ('delivered', 'partially_billed', 'billed')
- `show_tax`, `notes`

**DeliveryNoteItem** (Lieferschein-Positionen)

- `id`, `delivery_note_id` (FK), `product_id` (FK)
- `description`, `quantity`, `unit_price`, `total`

**ConsignmentStock** (Kommissionslager beim WiederverkÃ¤ufer)

- `id`, `customer_id` (FK), `product_id` (FK)
- `quantity` (aktueller Bestand beim Reseller)
- `unit_price` (Reseller-Preis)
- `last_delivery_note_id` (FK), `last_updated`
- **UNIQUE**: (customer_id, product_id)

### Weitere

**PaymentCheck** (ZahlungsprÃ¼fung)

- Automatische Abgleiche von ZahlungseingÃ¤ngen

**Reminder** (Mahnungen)

- Mahnstufen fÃ¼r Ã¼berfÃ¤llige Rechnungen

______________________________________________________________________

## ğŸ”‘ Naming Conventions

### Python (PEP 8)

- **Klassen**: `PascalCase` (z.B. `Invoice`, `LineItem`)
- **Funktionen/Methoden**: `snake_case` (z.B. `create_invoice`, `generate_hash`)
- **Variablen**: `snake_case` (z.B. `invoice_number`, `total_amount`)
- **Konstanten**: `UPPER_SNAKE_CASE` (z.B. `DEFAULT_TAX_RATE`)
- **Private**: `_leading_underscore` (z.B. `_calculate_internal`)

### Datenbank

- **Tabellen**: `snake_case` Plural (z.B. `invoices`, `line_items`)
- **Spalten**: `snake_case` (z.B. `invoice_number`, `created_at`)
- **FKs**: `[table]_id` (z.B. `customer_id`, `product_id`)
- **Indizes**: `idx_[table]_[column]` (z.B. `idx_invoices_status`)

### Templates

- **Dateien**: `snake_case.html` (z.B. `create_invoice.html`)
- **Ordner**: Singular (z.B. `invoices/`, `customers/`)
- **Base-Template**: `base.html`

### Routes

- **URL-Pattern**: `/resource` oder `/resource/<id>/action`
  - Liste: `/invoices`
  - Einzeln: `/invoices/<id>`
  - Aktion: `/invoices/<id>/cancel`
- **Funktionsnamen**: `action_resource` (z.B. `list_invoices`,
  `delete_customer`)

______________________________________________________________________

## ğŸ’¼ Business-Logik

### Steuerberechnung

**3 Steuermodelle:**

1. **'standard'** - Normale MwSt.

   - MwSt. wird auf Netto aufgeschlagen
   - `total = subtotal + tax_amount`
   - Formel: `tax_amount = subtotal * (tax_rate / 100)`

1. **'kleinunternehmer'** - Â§19 UStG

   - Keine MwSt.
   - `total = subtotal`, `tax_amount = 0`
   - Hinweis auf PDF: "Kleinunternehmerregelung..."

1. **'landwirtschaft'** - Â§24 UStG (Durchschnittssatz)

   - **WICHTIG**: Brutto = Netto, MwSt. wird rÃ¼ckgerechnet
   - `total = subtotal`
   - Formel: `tax_amount = subtotal * (tax_rate / (100 + tax_rate))`
   - Standard-Satz: 7,8% (fÃ¼r Honig, Eier, etc.)

**Produktspezifische SteuersÃ¤tze:**

- Jedes `Product` hat eigenes `tax_rate` Feld
- `LineItem.tax_rate` Ã¼bernimmt vom Produkt
- Bei Berechnung: Verwende `item.tax_rate` statt `invoice.tax_rate`

### Rechnungsnummern

**Format:** `[PREFIX]-YYYYMMDD-####`

**PrÃ¤fixe:**

- `RE-` - Normale Rechnung (Standard)
- `STORNO-` - Stornierungsrechnung
- `BAR-` - Barverkauf (POS/Kasse)

**Beispiele:**

- `RE-2024-11-08-0001` - Erste Rechnung am 8.11.2024
- `STORNO-20241108-0001` - Erste Storno am 8.11.2024
- `BAR-20241108-0042` - 42. Barverkauf am 8.11.2024

**ZÃ¤hler:** Pro PrÃ¤fix und Tag eigenstÃ¤ndig

### Bestandsverwaltung

**Hauptbestand** (`Product.number`)

- Reduziert bei: Rechnung (sent), POS-Verkauf
- ErhÃ¶ht bei: Stornierung, Entwurf-LÃ¶schung
- Methoden: `product.reduce_stock(qty)`, `product.increase_stock(qty)`

**Kommissionsbestand** (`ConsignmentStock.quantity`)

- Bestand beim WiederverkÃ¤ufer
- ErhÃ¶ht bei: Lieferschein-Auslieferung
- Reduziert bei: Abrechnung, Stornierung
- Pro Reseller + Produkt eindeutig

**Bei Stornierung:**

```python
# 1. Hauptbestand zurÃ¼ck
product.increase_stock(abs(item.quantity))

# 2. Kommissionsbestand zurÃ¼ck (falls vorhanden)
if consignment_item:
    consignment_item.quantity += abs(item.quantity)
```

### WiederverkÃ¤ufer-Workflow

1. **Lieferschein erstellen**

   - Produkte auswÃ¤hlen, Mengen festlegen
   - Reseller-Preise verwenden
   - Status: 'delivered'

1. **Bestand aktualisieren**

   - Hauptbestand reduzieren: `product.number -= qty`
   - Kommissionsbestand erhÃ¶hen: `consignment_stock.quantity += qty`

1. **Abrechnung**

   - Rechnung aus Lieferschein erstellen
   - Nur verkaufte Menge abrechnen
   - Status: 'partially_billed' oder 'billed'

1. **RÃ¼ckgabe**

   - Stornierung erstellt Gutschrift
   - Bestand zurÃ¼ckbuchen

______________________________________________________________________

## ğŸ¨ Frontend-Patterns

### Flash-Messages

**Kategorien:**

- `success` - GrÃ¼n (Erfolg)
- `danger` / `error` - Rot (Fehler)
- `warning` - Gelb (Warnung)
- `info` - Blau (Information)

**Verwendung:**

```python
flash('Rechnung erfolgreich erstellt!', 'success')
flash('Fehler: Nicht genug Bestand', 'danger')
flash('Achtung: Entwurf wird gelÃ¶scht', 'warning')
```

### Status-Badges

**Invoice Status:**

- `draft` â†’ ğŸŸ  Orange Badge
- `sent` â†’ ğŸ”µ Blau Badge
- `paid` â†’ ğŸŸ¢ GrÃ¼n Badge
- `cancelled` â†’ âš« Grau Badge

**Template:**

```html
<span class="badge badge-{{ invoice.status }}">
    {{ invoice.status|upper }}
</span>
```

### Formulare

**Standard-Struktur:**

```html
<form method="POST" action="{{ url_for('route_name') }}">
    <div class="form-group">
        <label for="field">Label</label>
        <input type="text" id="field" name="field" required>
    </div>
    <button type="submit" class="btn btn-primary">Speichern</button>
</form>
```

**Wichtig:**

- `required` fÃ¼r Pflichtfelder
- `name` Attribute fÃ¼r POST-Daten
- CSRF-Protection (automatisch in Flask)

### Navigation

**Haupt-Navigation** (`base.html`):

- Dashboard, Rechnungen, Neue Rechnung
- ğŸª Kasse (grÃ¼n hervorgehoben)
- Lieferscheine, Kunden, Produkte, Bestand
- Zahlungen, Einstellungen
- **User-Info** (rechts oben): Username, Rolle, Abmelden

**Conditional Rendering:**

```html
{% if current_user.is_authenticated %}
    {% if current_user.has_role('admin') %}
        <!-- Nur fÃ¼r Admins -->
    {% endif %}
{% endif %}
```

______________________________________________________________________

## ğŸ¯ Wichtige Workflows

### Rechnung erstellen

**Route:** `GET/POST /invoices/create`

**Ablauf:**

1. Kunde auswÃ¤hlen oder neu anlegen
1. Produkte hinzufÃ¼gen (mit Menge)
1. Steuermodell wÃ¤hlen
1. `status = 'draft'` (noch Ã¤nderbar/lÃ¶schbar)
1. Totals berechnen
1. LineItems erstellen
1. **Hash generieren** (vor db.session.add!)
1. Status-Log erstellen
1. Speichern

**Code-Pattern:**

```python
invoice = Invoice(...)
line_items = [LineItem(...), ...]
invoice.line_items = line_items
invoice.calculate_totals()
invoice.generate_hash()  # VOR add()!

log = InvoiceStatusLog(
    invoice_id=invoice.id,
    old_status=None,
    new_status='draft',
    changed_by=current_user.username
)

db.session.add(invoice)
db.session.add(log)
db.session.commit()
```

### Rechnung versenden

**Route:** `POST /invoices/<id>/status` mit `new_status='sent'`

**Effekt:**

- âœ… Status â†’ 'sent'
- âœ… UnverÃ¤nderbarkeit greift
- âœ… 10-Jahre-Aufbewahrungspflicht
- âœ… Status-Log erstellt
- âŒ Keine LÃ¶schung mehr mÃ¶glich

### Stornorechnung

**Route:** `GET/POST /invoices/<id>/cancel`

**Nur fÃ¼r:** status='sent' oder 'paid'

**Ablauf:**

1. Original-Rechnung laden
1. Neue Rechnung erstellen mit negativen BetrÃ¤gen
1. Rechnungsnummer: `STORNO-YYYYMMDD-####`
1. LineItems kopieren (quantity * -1, total * -1)
1. Bestand zurÃ¼ckbuchen (Haupt + Kommission)
1. Original-Status â†’ 'cancelled'
1. Beide Status-Logs erstellen
1. Hash fÃ¼r Storno generieren

### POS-Verkauf (Kasse)

**Route:** `GET /pos`, `POST /api/pos/complete_sale`

**Mobile-optimiert** (responsive Design)

**Ablauf:**

1. Produkte anzeigen mit ZÃ¤hler (+/-)
1. Echtzeit-Bon-Vorschau (Datum, Uhrzeit, Summe)
1. "Verkauf abschlieÃŸen" â†’ AJAX-Request
1. Backend erstellt BAR-Rechnung
   - customer_id = "Barverkauf"-Kunde
   - status = 'paid' (sofort bezahlt)
   - payment_method = 'Barzahlung'
1. Bestand reduzieren
1. Hash generieren
1. Status-Log erstellen
1. Erfolg â†’ Warenkorb leeren

### Entwurf lÃ¶schen

**Route:** `POST /invoices/<id>/delete`

**Nur fÃ¼r:** status='draft'

**Ablauf:**

1. Validierung: `if invoice.status != 'draft': FEHLER`
1. Bestand zurÃ¼ckbuchen (LineItems)
1. Kommissionsbestand zurÃ¼ckbuchen (falls vorhanden)
1. LineItems lÃ¶schen (CASCADE)
1. Status-Logs lÃ¶schen (CASCADE)
1. Rechnung lÃ¶schen

**Rechtfertigung:** Entwurf ist kein GeschÃ¤ftsvorfall (GoBD)

______________________________________________________________________

**Alle Ã„nderungen MÃœSSEN GoBD-konform sein!** Siehe `GOBD_COMPLIANCE.md` fÃ¼r
Details.

### UnverÃ¤nderbarkeit (Immutability)

**Status-Workflow:**

```
draft â†’ sent â†’ paid
   â†“          â†“
DELETE    cancelled
```

**VERBOTEN:**

- âŒ Versendete Rechnungen (status='sent') lÃ¶schen â†’ NUR Stornierung erlaubt
- âŒ Bezahlte Rechnungen (status='paid') lÃ¶schen â†’ NUR Stornierung erlaubt
- âŒ Status zurÃ¼cksetzen von 'sent' auf 'draft'
- âŒ Rechnungsdaten nach Status='sent' Ã¤ndern

**ERLAUBT:**

- âœ… EntwÃ¼rfe (status='draft') lÃ¶schen
- âœ… Stornierung durch Stornorechnung (negative BetrÃ¤ge, BestandsrÃ¼ckbuchung)
- âœ… Status vorwÃ¤rts Ã¤ndern: draft â†’ sent â†’ paid

### Audit Trail

**Bei JEDER Status-Ã„nderung:**

```python
log_entry = InvoiceStatusLog(
    invoice_id=invoice.id,
    old_status=old_status,
    new_status=new_status,
    changed_by=current_user.username,  # IMMER aktuellen User verwenden!
    reason=reason
)
db.session.add(log_entry)
```

### Hash-IntegritÃ¤t

**Bei Rechnung-Erstellung/-Ã„nderung:**

```python
# Pattern: Erst line_items zuweisen, DANN Hash generieren, DANN add/flush
invoice.line_items = line_items_list
invoice.generate_hash()
db.session.add(invoice)
db.session.flush()
```

**WICHTIG:** Hash MUSS vor `db.session.add()` generiert werden (wegen
DB-Trigger)!

### PDF-Archivierung

**Beim ersten PDF-Download (status='sent'):**

```python
pdf_hash = hashlib.sha256(pdf_bytes).hexdigest()
archive = InvoicePdfArchive(
    invoice_id=invoice.id,
    pdf_filename=filename,
    pdf_hash=pdf_hash,
    file_size=len(pdf_bytes),
    archived_by=current_user.username
)
db.session.add(archive)
```

______________________________________________________________________

## ğŸ”’ Authentifizierung & Autorisierung

### Rollen-System

**Rollen:**

- `admin`: Volle Rechte (alle Features)
- `cashier`: Nur Kasse + Rechnungen ansehen
- `reseller`: Eigener Bestand + eigene Preise (zukÃ¼nftig)

**Route-Protection:**

```python
@app.route('/admin/users')
@login_required
@role_required('admin')
def manage_users():
    # Nur fÃ¼r Admins
```

**Kassen-Route (cashier + admin):**

```python
@app.route('/pos')
@login_required
@role_required('cashier', 'admin')
def pos():
    # FÃ¼r Kassierer und Admins
```

### Audit-Trail mit User

**IMMER `current_user` verwenden statt "System":**

```python
# âœ… RICHTIG
log_entry.changed_by = current_user.username

# âŒ FALSCH
log_entry.changed_by = 'System'
```

______________________________________________________________________

## ğŸ“ Git-Workflow

**Nach JEDER Ã„nderung automatisch committen:**

```bash
git add .
git commit -m "[Beschreibung der Ã„nderung]"
```

### Commit-Message-Format

**Feature/Neu:**

```
feat: [Kurze Beschreibung]

- Detail 1
- Detail 2
- GoBD: [Relevante Compliance-Info wenn anwendbar]
```

**Bugfix:**

```
fix: [Problem-Beschreibung]

- Was war das Problem
- Was wurde gefixt
- GoBD: [Falls betroffen]
```

**Datenbank/Migration:**

```
db: [Migration-Beschreibung]

- Neue Tabellen: [Liste]
- GeÃ¤nderte Felder: [Liste]
- Migration-Script: [Dateiname]
```

**Authentifizierung/Sicherheit:**

```
auth: [Ã„nderung]

- Details
- Betroffene Routen: [Liste]
```

**Beispiele:**

```bash
# Feature
git commit -m "feat: User-Management fÃ¼r Admins

- User-Liste mit Filter
- User erstellen/bearbeiten/deaktivieren
- Rollen-Zuweisung
- GoBD: changed_by verwendet jetzt current_user"

# Bugfix
git commit -m "fix: Hash-Generierung in complete_pos_sale

- Hash wurde NACH db.session.add() generiert
- Trigger verhinderte NULL-Werte
- Jetzt: Hash VOR add() generieren"

# Migration
git commit -m "db: User-Tabelle fÃ¼r Authentifizierung

- Neue Tabelle: users
- Felder: username, email, password_hash, role, totp_secret
- Migration: migrations/create_users_table.py
- Standard-Admin: admin/admin123"
```

______________________________________________________________________

## ğŸ¨ Code-Style

### Python

**Flask-Routen:**

```python
@app.route('/endpoint', methods=['GET', 'POST'])
@login_required
@role_required('admin')
def my_route():
    """Docstring: Was macht diese Route"""
    if request.method == 'POST':
        # POST-Logik
        pass

    # GET-Logik
    return render_template('template.html')
```

**Datenbank-Operationen:**

```python
try:
    # Ã„nderungen
    db.session.add(obj)
    db.session.commit()
    flash('Erfolgsmeldung', 'success')
except Exception as e:
    db.session.rollback()
    flash(f'Fehler: {str(e)}', 'danger')
    return redirect(url_for('fallback_route'))
```

**GoBD-Validierung:**

```python
# Status-Ã„nderung validieren
if invoice.status == 'sent' and new_status == 'draft':
    flash('Fehler: Versendete Rechnungen kÃ¶nnen nicht zurÃ¼ck zu Entwurf (GoBD).', 'danger')
    return redirect(url_for('view_invoice', invoice_id=invoice.id))
```

### Templates

**Flash-Messages immer anzeigen:**

```html
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
    {% endif %}
{% endwith %}
```

**User-Info anzeigen:**

```html
{% if current_user.is_authenticated %}
    <span>ğŸ‘¤ {{ current_user.username }}</span>
    <span class="badge">{{ current_user.role }}</span>
{% endif %}
```

______________________________________________________________________

## ğŸ”§ Wichtige Patterns

### Hash-Generierung (GoBD)

```python
# KRITISCH: Reihenfolge beachten!
# 1. Invoice-Objekt erstellen
invoice = Invoice(...)

# 2. LineItems erstellen
line_items = [LineItem(...), LineItem(...)]

# 3. LineItems zuweisen
invoice.line_items = line_items

# 4. Hash generieren
invoice.generate_hash()

# 5. Zu Session hinzufÃ¼gen
db.session.add(invoice)
db.session.flush()
```

### Status-Ã„nderung mit Audit-Log

```python
def update_status(invoice, new_status, reason=None):
    old_status = invoice.status

    # Validierung (GoBD)
    if old_status == 'sent' and new_status == 'draft':
        raise ValueError('UnzulÃ¤ssige Status-Ã„nderung (GoBD)')

    # Status Ã¤ndern
    invoice.status = new_status

    # Audit-Log
    log_entry = InvoiceStatusLog(
        invoice_id=invoice.id,
        old_status=old_status,
        new_status=new_status,
        changed_by=current_user.username,
        reason=reason
    )
    db.session.add(log_entry)
    db.session.commit()
```

### Bestandsverwaltung

```python
# Bestand reduzieren (beim Verkauf)
if not product.reduce_stock(quantity):
    raise ValueError(f'Nicht genug Bestand: {product.name}')

# Bestand erhÃ¶hen (bei Stornierung)
product.increase_stock(quantity)
```

______________________________________________________________________

## ğŸ“š Wichtige Dateien

| Datei | Zweck | |-------|-------| | `GOBD_COMPLIANCE.md` | **PFLICHTLEKTÃœRE**
\- GoBD-Verfahrensdokumentation | | `models.py` | Datenbankmodelle (User,
Invoice, Product, etc.) | | `app.py` | Flask-Routes, App-Factory | | `config.py`
| Konfiguration (Firma, Steuern, Token-GÃ¼ltigkeit) | | `.env` | Secrets (nicht
committen!) | | `migrations/` | Datenbank-Migrationen | | `templates/` |
Jinja2-Templates | | `templates/auth/` | Login, 2FA |

______________________________________________________________________

## âš ï¸ Was NIEMALS tun

- âŒ Versendete Rechnungen lÃ¶schen
- âŒ Hash nach `db.session.add()` generieren
- âŒ Status zurÃ¼cksetzen (sentâ†’draft, paidâ†’sent)
- âŒ `changed_by='System'` verwenden (immer `current_user.username`)
- âŒ Secrets in Code committen
- âŒ Ã„nderungen ohne Git-Commit lassen
- âŒ Migrations ohne Test ausfÃ¼hren

______________________________________________________________________

## âœ… Best Practices

1. **Lies `GOBD_COMPLIANCE.md`** vor jeder Ã„nderung an Rechnungen
1. **Teste Migrations** erst auf Entwicklungs-DB
1. **Flash-Messages** fÃ¼r User-Feedback
1. **Try-Except** bei DB-Operationen
1. **Audit-Logging** bei allen wichtigen Aktionen
1. **Git-Commit** nach jeder Ã„nderung
1. **current_user** fÃ¼r Audit-Trail
1. **Route-Protection** mit `@login_required` und `@role_required`

______________________________________________________________________

## ğŸš€ NÃ¤chste Features (Roadmap)

- [ ] Route-Protection fÃ¼r alle Routen
- [ ] 2FA-Setup-Interface
- [ ] User-Management (Admin)
- [ ] JWT-API fÃ¼r PWA
- [ ] Progressive Web App (offline-fÃ¤hig)
- [ ] Reseller-System (eigener Bestand + Preise)
- [ ] Automatische Backups

______________________________________________________________________

**Bei Unsicherheiten:** Frag nach! GoBD-Compliance ist kritisch fÃ¼r
Finanzamt-PrÃ¼fungen.

______________________________________________________________________

## âœ¨ Implementierte Features (Stand 08.11.2025)

### Rechnungsverwaltung

- âœ… Rechnungen erstellen/bearbeiten/lÃ¶schen (draft only)
- âœ… Status-Workflow (draft â†’ sent â†’ paid, cancelled)
- âœ… Stornorechnungen mit BestandsrÃ¼ckbuchung
- âœ… PDF-Generierung (ReportLab)
- âœ… SHA-256 Hash-Schutz (GoBD)
- âœ… Audit-Trail (InvoiceStatusLog)
- âœ… PDF-Archivierung mit Hash (InvoicePdfArchive)
- âœ… Filter: Alle, EntwÃ¼rfe, Versendet, Bezahlt, Stornorechnungen
- âœ… Fortlaufende Rechnungsnummern (pro Tag/PrÃ¤fix)

### Kundenverwaltung

- âœ… Kunden anlegen/bearbeiten
- âœ… Kundentypen: Endkunde, WiederverkÃ¤ufer
- âœ… Adressverwaltung
- âœ… Kundenliste mit Suche

### Produktverwaltung

- âœ… Produkte anlegen/bearbeiten/deaktivieren
- âœ… BestandsfÃ¼hrung (Hauptlager)
- âœ… Reseller-Preise
- âœ… Produktspezifische SteuersÃ¤tze
- âœ… Chargennummern

### Lieferscheine & Kommissionsware

- âœ… Lieferscheine erstellen
- âœ… Kommissionslager-Verwaltung
- âœ… Bestandstracking pro Reseller
- âœ… Abrechnung aus Lieferscheinen

### Point-of-Sale (Kasse)

- âœ… Mobile-optimierte Kassen-UI
- âœ… Echtzeit-Bon-Vorschau
- âœ… BAR-Rechnungen (sofort bezahlt)
- âœ… Touch-optimiert (45x45px Buttons)
- âœ… Live Datum/Uhrzeit
- âœ… GoBD-konform (Hash, Status-Log)

### Zahlungsmanagement

- âœ… ZahlungsprÃ¼fung (PaymentCheck)
- âœ… Mahnungen (Reminder)
- âœ… ZahlungseingÃ¤nge abgleichen

### Authentifizierung & Sicherheit

- âœ… User-Modell (admin, cashier, reseller)
- âœ… Login/Logout (Flask-Login)
- âœ… Passwort-Hashing (Werkzeug)
- âœ… 2FA-Infrastruktur (TOTP, Backup-Codes)
- âœ… API-Token-Support (fÃ¼r PWA)
- âœ… Session-Management

### GoBD-KonformitÃ¤t

- âœ… UnverÃ¤nderbarkeit (Hash-Protection)
- âœ… Audit-Trail (alle Status-Ã„nderungen)
- âœ… PDF-Archivierung mit SHA-256
- âœ… Entwurfs-LÃ¶schung erlaubt
- âœ… Stornierung durch Gegenbuchung
- âœ… 10-Jahre-Aufbewahrung
- âœ… VollstÃ¤ndige Verfahrensdokumentation

### Noch NICHT implementiert (TODO)

- â³ Route-Protection (@login_required fÃ¼r alle Routen)
- â³ 2FA-Setup-Interface (QR-Code-Anzeige)
- â³ User-Management-UI (Admin-Panel)
- â³ JWT-API-Endpoints (fÃ¼r PWA)
- â³ Progressive Web App (PWA)
- â³ current_user in Audit-Logs (noch "System")
- â³ Reseller-Self-Service (eigener Login)
- â³ Email-Versand fÃ¼r Rechnungen
- â³ Automatische Backups

______________________________________________________________________

## ğŸ”§ Entwicklungs-Workflow

### Lokale Entwicklung starten

```bash
# 1. Virtuelle Umgebung aktivieren
source venv/bin/activate  # Linux/Mac
# oder: venv\Scripts\activate  # Windows

# 2. AbhÃ¤ngigkeiten installieren
pip install -r requirements.txt

# 3. Umgebungsvariablen setzen (.env)
# DATABASE_URL, SECRET_KEY, COMPANY_*, BANK_*

# 4. Datenbank migrieren (falls nÃ¶tig)
python migrations/create_users_table.py

# 5. App starten
python app.py
# oder: flask run --port 5000
```

### Datenbank-Migrationen erstellen

**Pattern:**

1. `models.py` Ã¤ndern
1. Migrations-Skript erstellen: `migrations/add_[feature].py`
1. App-Context verwenden: `app = create_app()`
1. `db.create_all()` fÃ¼r neue Tabellen
1. Bestehende Daten migrieren (falls nÃ¶tig)
1. Testen!
1. Git-Commit

**Beispiel:**

```python
#!/usr/bin/env python3
from app import create_app
from models import db, NewModel

def migrate():
    app = create_app()
    with app.app_context():
        db.create_all()
        print("âœ“ Migration erfolgreich")

if __name__ == '__main__':
    migrate()
```

### Testing

**Aktuell:** Manuelles Testing

- Login testen (admin/admin123)
- Rechnung erstellen
- PDF generieren
- Hash verifizieren
- Storno testen
- POS testen

**ZukÃ¼nftig:** Unit-Tests + Integration-Tests

______________________________________________________________________

## ğŸ› Debugging-Tipps

### Hash-IntegritÃ¤tsfehler

**Problem:** "Hash stimmt nicht Ã¼berein"

**Ursachen:**

1. Hash wurde NACH `db.session.add()` generiert
1. LineItems wurden nach Hash-Generierung geÃ¤ndert
1. Datenbank-Manipulation

**LÃ¶sung:**

```python
# RICHTIG:
invoice.line_items = items_list
invoice.calculate_totals()
invoice.generate_hash()  # VOR add()!
db.session.add(invoice)

# FALSCH:
db.session.add(invoice)
invoice.generate_hash()  # Zu spÃ¤t! Trigger verhindert Update
```

### "NULL value in column data_hash"

**Problem:** Database-Trigger `protect_invoice_hash()` verhindert NULL

**LÃ¶sung:** Hash VOR `db.session.add()` generieren (siehe oben)

### Status-Ã„nderung wird abgelehnt

**Problem:** "Versendete Rechnungen kÃ¶nnen nicht zurÃ¼ck zu Entwurf"

**ErklÃ¤rung:** GoBD-Regel - BEABSICHTIGT!

**LÃ¶sung:** Stornierung verwenden statt Status-RÃ¼cknahme

### Bestand wird nicht reduziert

**Problem:** `product.number` Ã¤ndert sich nicht

**PrÃ¼fen:**

1. Wird `product.reduce_stock(qty)` aufgerufen?
1. Gibt Funktion `False` zurÃ¼ck? (Nicht genug Bestand)
1. Wurde `db.session.commit()` vergessen?

**Debug:**

```python
if not product.reduce_stock(quantity):
    print(f"Fehler: Bestand nicht ausreichend! {product.number} < {quantity}")
    db.session.rollback()
```

### Login funktioniert nicht

**PrÃ¼fen:**

1. User existiert? `User.query.filter_by(username='admin').first()`
1. Passwort korrekt? `user.check_password('admin123')`
1. User aktiv? `user.is_active == True`
1. Flask-Login initialisiert? `login_manager.init_app(app)`

______________________________________________________________________

## ğŸ“š Konfiguration (config.py / .env)

### Pflicht-Variablen

```bash
# .env Beispiel
SECRET_KEY=your-secret-key-here-change-in-production
DATABASE_URL=postgresql://user:password@localhost/rechnungen

# Firma
COMPANY_NAME=Imkerei Mustermann
COMPANY_HOLDER=Max Mustermann
COMPANY_STREET=Bienenweg 42
COMPANY_ZIP=12345
COMPANY_CITY=Honigstadt
COMPANY_EMAIL=info@imkerei-mustermann.de
COMPANY_PHONE=+49 123 456789
COMPANY_TAX_ID=DE123456789

# Bank
BANK_NAME=Sparkasse Honigstadt
BANK_IBAN=DE00 0000 0000 0000 0000 00
BANK_BIC=SPARKDE01

# Optional
PAYPAL=paypal@imkerei-mustermann.de
DEFAULT_TAX_RATE=19.00
LANDWIRTSCHAFTLICHE_URPRODUKTION_TAX_RATE=7.80
API_TOKEN_EXPIRY_DAYS=30
```

### Steuerung Ã¼ber Config

**Zugriff in Code:**

```python
from flask import current_app

company_name = current_app.config['COMPANY_NAME']
tax_rate = current_app.config['DEFAULT_TAX_RATE']
token_days = current_app.config['API_TOKEN_EXPIRY_DAYS']
```

______________________________________________________________________

## ğŸ“ Lern-Ressourcen

**GoBD:**

- `GOBD_COMPLIANCE.md` (vollstÃ¤ndige Dokumentation)
- BMF-Schreiben 28.11.2019
- IHK-LeitfÃ¤den

**Flask:**

- https://flask.palletsprojects.com/
- Flask-Login: https://flask-login.readthedocs.io/
- SQLAlchemy: https://docs.sqlalchemy.org/

**Steuerrecht (Deutschland):**

- Â§24 UStG - DurchschnittssÃ¤tze Land- und Forstwirtschaft
- Â§19 UStG - Kleinunternehmer
- GoBD - OrdnungsmÃ¤ÃŸige BuchfÃ¼hrung

______________________________________________________________________
