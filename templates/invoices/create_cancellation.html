{% extends "base.html" %}

{% block title %}Stornorechnung erstellen{% endblock %}

{% block content %}
<div style="max-width: 800px; margin: 0 auto;">
    <h1>Stornorechnung erstellen</h1>
    
    <div class="card" style="background: #fff3cd; border-left: 4px solid #856404; margin-bottom: 2rem;">
        <h3 style="color: #856404; margin-top: 0;">‚ö†Ô∏è Wichtiger Hinweis (GoBD-Konformit√§t)</h3>
        <p>
            Sie erstellen eine <strong>Stornorechnung</strong> f√ºr:
        </p>
        <ul>
            <li>Rechnungsnummer: <strong>{{ invoice.invoice_number }}</strong></li>
            <li>Kunde: <strong>{{ invoice.customer.company_name or (invoice.customer.first_name + ' ' + invoice.customer.last_name) }}</strong></li>
            <li>Betrag: <strong>{{ "%.2f"|format(invoice.total) }} ‚Ç¨</strong></li>
            <li>Datum: <strong>{{ invoice.invoice_date.strftime('%d.%m.%Y') }}</strong></li>
        </ul>
        
        <p style="margin-bottom: 0;">
            <strong>Was passiert:</strong>
        </p>
        <ul style="margin-bottom: 0;">
            <li>‚úì Eine neue Rechnung mit <strong>negativen Betr√§gen</strong> wird erstellt</li>
            <li>‚úì Die Original-Rechnung wird als <strong>storniert</strong> markiert</li>
            <li>‚úì Der <strong>Bestand wird zur√ºckgebucht</strong></li>
            <li>‚úì Alle √Ñnderungen werden <strong>protokolliert</strong> (Audit Trail)</li>
            <li>‚úì Die Original-Rechnung bleibt <strong>unver√§nderbar</strong> im System</li>
        </ul>
    </div>
    
    <div class="card">
        <h2>Stornierungsdetails</h2>
        
        <form method="POST">
            <div class="form-group">
                <label for="reason">Grund f√ºr Stornierung *</label>
                <textarea name="reason" id="reason" rows="4" required 
                          placeholder="z.B. Kunde hat Ware zur√ºckgegeben, Fehler in der Rechnung, etc."></textarea>
                <small style="color: #7f8c8d;">
                    Der Grund wird in der Stornorechnung und im Audit Trail dokumentiert.
                </small>
            </div>
            
            <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #ddd;">
                <button type="submit" class="btn" style="background: #e74c3c; color: white; font-size: 1.1rem;">
                    üóëÔ∏è Stornorechnung jetzt erstellen
                </button>
                <a href="{{ url_for('view_invoice', invoice_id=invoice.id) }}" 
                   class="btn" style="background: #95a5a6; color: white; margin-left: 0.5rem;">
                    Abbrechen
                </a>
            </div>
        </form>
    </div>
    
    <div class="card" style="background: #e3f2fd; border-left: 4px solid #2196f3;">
        <h3 style="color: #1976d2; margin-top: 0;">‚ÑπÔ∏è Rechnungspositionen</h3>
        <p style="margin-bottom: 1rem;">
            Folgende Positionen werden mit <strong>negativen Betr√§gen</strong> storniert:
        </p>
        
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #ddd;">
                    <th style="text-align: left; padding: 0.5rem;">Beschreibung</th>
                    <th style="text-align: right; padding: 0.5rem;">Menge</th>
                    <th style="text-align: right; padding: 0.5rem;">Einzelpreis</th>
                    <th style="text-align: right; padding: 0.5rem;">Gesamt</th>
                </tr>
            </thead>
            <tbody>
                {% for item in invoice.line_items %}
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 0.5rem;">{{ item.description }}</td>
                    <td style="text-align: right; padding: 0.5rem;">{{ "%.2f"|format(item.quantity) }}</td>
                    <td style="text-align: right; padding: 0.5rem;">{{ "%.2f"|format(item.unit_price) }} ‚Ç¨</td>
                    <td style="text-align: right; padding: 0.5rem;">{{ "%.2f"|format(item.total) }} ‚Ç¨</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr style="border-top: 2px solid #ddd; font-weight: bold;">
                    <td colspan="3" style="text-align: right; padding: 0.5rem;">Zwischensumme:</td>
                    <td style="text-align: right; padding: 0.5rem;">{{ "%.2f"|format(invoice.subtotal) }} ‚Ç¨</td>
                </tr>
                <tr>
                    <td colspan="3" style="text-align: right; padding: 0.5rem;">MwSt ({{ "%.2f"|format(invoice.tax_rate) }}%):</td>
                    <td style="text-align: right; padding: 0.5rem;">{{ "%.2f"|format(invoice.tax_amount) }} ‚Ç¨</td>
                </tr>
                <tr style="font-size: 1.2rem; background: #f8f9fa;">
                    <td colspan="3" style="text-align: right; padding: 0.5rem;"><strong>Gesamt:</strong></td>
                    <td style="text-align: right; padding: 0.5rem;"><strong>{{ "%.2f"|format(invoice.total) }} ‚Ç¨</strong></td>
                </tr>
            </tfoot>
        </table>
        
        <p style="margin-top: 1rem; margin-bottom: 0; font-size: 0.9rem; color: #555;">
            <strong>Nach Stornierung:</strong> Alle Betr√§ge werden mit <span style="color: #e74c3c;">negativem Vorzeichen (-)</span> in der Stornorechnung erscheinen.
        </p>
    </div>
</div>
{% endblock %}
