{% extends "base.html" %}

{% block title %}Einstellungen{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>‚öôÔ∏è Einstellungen</h1>
    <div style="display: flex; gap: 1rem;">
        <a href="{{ url_for('list_users') }}" class="btn" style="background: #007bff; color: white;">
            üë• Benutzerverwaltung
        </a>
        <form method="POST" action="{{ url_for('test_email_settings') }}" style="display: inline;">
            <button type="submit" class="btn" style="background: #9b59b6; color: white;">
                üìß E-Mail √ºberpr√ºfen
            </button>
        </form>
    </div>
</div>

<div class="flash warning">
    <strong>Hinweis:</strong> Um Ihre Firmendaten zu √§ndern, bearbeiten Sie die Datei <code>.env</code> im Projektverzeichnis und starten Sie die Anwendung neu.
</div>

<div class="card">
    <h2>üîê Zwei-Faktor-Authentifizierung (2FA)</h2>
    <p style="color: #7f8c8d; margin-bottom: 1.5rem;">Zus√§tzliche Sicherheit f√ºr Ihren Account.</p>

    {% if current_user.totp_enabled %}
    <div style="padding: 1rem; background: #d4edda; border-left: 4px solid #28a745; border-radius: 4px; margin-bottom: 1rem;">
        <strong>‚úì 2FA ist aktiviert</strong><br>
        <span style="color: #155724;">Ihr Account ist durch Zwei-Faktor-Authentifizierung gesch√ºtzt.</span>
        {% if current_user.totp_required %}
        <br><span style="background: #ff9800; color: white; padding: 0.3rem 0.6rem; border-radius: 3px; font-size: 0.85rem; margin-top: 0.5rem; display: inline-block;">
            üîí 2FA ist Pflicht und kann nicht deaktiviert werden
        </span>
        {% endif %}
    </div>

    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
        <form method="POST" action="{{ url_for('regenerate_backup_codes') }}" style="display: inline;">
            <input type="password" name="password" placeholder="Passwort best√§tigen" required
                   style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-right: 0.5rem;">
            <button type="submit" class="btn" style="background: #17a2b8; color: white;">
                üîÑ Backup-Codes neu generieren
            </button>
        </form>

        {% if not current_user.totp_required %}
        <form method="POST" action="{{ url_for('disable_2fa') }}" style="display: inline;"
              onsubmit="return confirm('Sind Sie sicher, dass Sie 2FA deaktivieren m√∂chten?');">
            <input type="password" name="password" placeholder="Passwort best√§tigen" required
                   style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; margin-right: 0.5rem;">
            <button type="submit" class="btn" style="background: #dc3545; color: white;">
                ‚ùå 2FA deaktivieren
            </button>
        </form>
        {% endif %}
    </div>
    {% else %}
    <div style="padding: 1rem; background: {% if current_user.totp_required %}#ffebee{% else %}#fff3cd{% endif %}; border-left: 4px solid {% if current_user.totp_required %}#e74c3c{% else %}#ffc107{% endif %}; border-radius: 4px; margin-bottom: 1rem;">
        <strong>{% if current_user.totp_required %}üö® 2FA ist Pflicht{% else %}‚ö† 2FA ist nicht aktiviert{% endif %}</strong><br>
        <span style="color: {% if current_user.totp_required %}#c0392b{% else %}#856404{% endif %};">
            {% if current_user.totp_required %}
                Ihr Administrator hat 2FA f√ºr Ihren Account verpflichtend gemacht. Bitte richten Sie 2FA jetzt ein.
            {% else %}
                Erh√∂hen Sie die Sicherheit Ihres Accounts durch Zwei-Faktor-Authentifizierung.
            {% endif %}
        </span>
    </div>

    <a href="{{ url_for('setup_2fa') }}" class="btn" style="background: #28a745; color: white;">
        <i class="bi bi-shield-lock"></i> 2FA jetzt aktivieren
    </a>

    <div style="margin-top: 1.5rem; padding: 1rem; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
        <strong>üí° Was ist 2FA?</strong><br>
        Zwei-Faktor-Authentifizierung (2FA) sch√ºtzt Ihren Account durch einen zweiten Faktor zus√§tzlich zum Passwort.
        Sie ben√∂tigen eine Authenticator-App wie Google Authenticator, Authy oder Microsoft Authenticator.
    </div>
    {% endif %}
</div>

<div class="card">
    <h2>E-Mail-Konfiguration</h2>
    <p style="color: #7f8c8d; margin-bottom: 1.5rem;">SMTP (Versand) und IMAP (Empfang) Einstellungen.</p>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
        <div>
            <h3 style="margin-bottom: 1rem; color: #3498db;">üì§ SMTP (Versand)</h3>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 0.5rem; font-size: 0.9rem;">
                <div><strong>Server:</strong></div>
                <div>{{ config.MAIL_SERVER }}</div>

                <div><strong>Port:</strong></div>
                <div>{{ config.MAIL_PORT }}</div>

                <div><strong>Username:</strong></div>
                <div>{{ config.MAIL_USERNAME }}</div>

                <div><strong>SSL/TLS:</strong></div>
                <div>
                    {% if config.MAIL_USE_SSL %}SSL
                    {% elif config.MAIL_USE_TLS %}TLS
                    {% else %}Keine{% endif %}
                </div>
            </div>
        </div>

        <div>
            <h3 style="margin-bottom: 1rem; color: #27ae60;">üì• IMAP (Empfang)</h3>
            <div style="display: grid; grid-template-columns: 120px 1fr; gap: 0.5rem; font-size: 0.9rem;">
                <div><strong>Server:</strong></div>
                <div>{{ config.IMAP_SERVER }}</div>

                <div><strong>Port:</strong></div>
                <div>{{ config.IMAP_PORT }}</div>

                <div><strong>Username:</strong></div>
                <div>{{ config.IMAP_USERNAME }}</div>

                <div><strong>SSL:</strong></div>
                <div>{% if config.IMAP_USE_SSL %}Ja{% else %}Nein{% endif %}</div>
            </div>
        </div>
    </div>

    <div style="margin-top: 1.5rem; padding: 1rem; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
        <strong>üí° Tipp:</strong> Klicken Sie auf "E-Mail √ºberpr√ºfen", um die Verbindung zu SMTP und IMAP zu testen.
    </div>
</div>

<div class="card">
    <h2>Firmendaten</h2>
    <p style="color: #7f8c8d; margin-bottom: 1.5rem;">Diese Daten erscheinen auf Ihren Rechnungen und PDFs.</p>

    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 1rem; margin-bottom: 2rem;">
        <div><strong>Firmenname:</strong></div>
        <div>{{ company.name }}</div>

        {% if company.holder %}
        <div><strong>Inhaber:</strong></div>
        <div>{{ company.holder }}</div>
        {% endif %}

        <div><strong>Stra√üe:</strong></div>
        <div>{{ company.street }}</div>

        <div><strong>PLZ / Ort:</strong></div>
        <div>{{ company.zip }} {{ company.city }}</div>

        <div><strong>Land:</strong></div>
        <div>{{ company.country }}</div>

        <div><strong>E-Mail:</strong></div>
        <div><a href="mailto:{{ company.email }}">{{ company.email }}</a></div>

        <div><strong>Telefon:</strong></div>
        <div>{{ company.phone }}</div>

        <div><strong>Steuernummer:</strong></div>
        <div>{{ company.tax_id }}</div>

        <div><strong>Website:</strong></div>
        <div>{{ company.website }}</div>
    </div>
</div>

<div class="card">
    <h2>Steuersatz</h2>
    <p style="color: #7f8c8d; margin-bottom: 1.5rem;">Standard-Mehrwertsteuersatz f√ºr neue Rechnungen.</p>

    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 1rem;">
        <div><strong>Standard MwSt.:</strong></div>
        <div>
            <span style="font-size: 1.5rem; font-weight: bold; color: #3498db;">{{ "%.2f"|format(config.DEFAULT_TAX_RATE) }}%</span>
            <div style="margin-top: 0.5rem; color: #7f8c8d; font-size: 0.9rem;">
                Beispiele: 19.00% (Normalsatz), 7.00% (erm√§√üigt), 10.70% (Landwirtschaft)
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h2>Bankverbindung</h2>
    <p style="color: #7f8c8d; margin-bottom: 1.5rem;">Diese Daten erscheinen auf Ihren Rechnungs-PDFs.</p>

    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 1rem;">
        <div><strong>Bank:</strong></div>
        <div>{{ bank.name }}</div>

        <div><strong>IBAN:</strong></div>
        <div><code style="background: #f8f9fa; padding: 0.3rem 0.6rem; border-radius: 4px;">{{ bank.iban }}</code></div>

        <div><strong>BIC:</strong></div>
        <div><code style="background: #f8f9fa; padding: 0.3rem 0.6rem; border-radius: 4px;">{{ bank.bic }}</code></div>
    </div>
</div>

<div class="card">
    <h2>üìù So √§ndern Sie Ihre Daten</h2>

    <ol style="line-height: 2;">
        <li>√ñffnen Sie die Datei <code>.env</code> im Projektverzeichnis:
            <pre style="background: #2c3e50; color: #ecf0f1; padding: 1rem; border-radius: 4px; margin: 0.5rem 0;">nano .env</pre>
        </li>

        <li>Bearbeiten Sie die folgenden Zeilen:
            <pre style="background: #f8f9fa; padding: 1rem; border-radius: 4px; margin: 0.5rem 0; overflow-x: auto;">COMPANY_NAME=Ihre Firma GmbH
COMPANY_HOLDER=Max Mustermann
COMPANY_STREET=Musterstra√üe 123
COMPANY_ZIP=12345
COMPANY_CITY=Musterstadt
COMPANY_EMAIL=info@ihre-firma.de
COMPANY_PHONE=+49 123 456789
COMPANY_TAX_ID=DE123456789

# Standard-Steuersatz f√ºr neue Rechnungen
DEFAULT_TAX_RATE=19.00

BANK_NAME=Ihre Bank
BANK_IBAN=DE00 0000 0000 0000 0000 00
BANK_BIC=BANKDEFF</pre>
        </li>

        <li>Speichern Sie die Datei (<kbd>Strg+O</kbd>, dann <kbd>Enter</kbd>, dann <kbd>Strg+X</kbd>)</li>

        <li>Starten Sie die Anwendung neu:
            <pre style="background: #2c3e50; color: #ecf0f1; padding: 1rem; border-radius: 4px; margin: 0.5rem 0;">python app.py --port 5001</pre>
        </li>
    </ol>

    <div style="margin-top: 1.5rem; padding: 1rem; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
        <strong>üí° Tipp:</strong> Laden Sie nach dem Neustart diese Seite neu, um die aktualisierten Daten zu sehen.
    </div>
</div>
{% endblock %}
