{% extends "base.html" %}

{% block title %}Neue Bestandsanpassung{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">üì¶ Neue Bestandsanpassung</h2>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <!-- Produkt ausw√§hlen -->
                        <div class="mb-3">
                            <label for="product_id" class="form-label">Produkt *</label>
                            <select name="product_id" id="product_id" class="form-select" required onchange="updateCurrentStock()">
                                <option value="">-- Produkt ausw√§hlen --</option>
                                {% for product in products %}
                                <option value="{{ product.id }}" data-stock="{{ product.number }}">
                                    {{ product.name }} (Aktuell: {{ product.number }} Stk)
                                </option>
                                {% endfor %}
                            </select>
                            <div id="current-stock-info" class="mt-2"></div>
                        </div>

                        <!-- Typ der Anpassung -->
                        <div class="mb-3">
                            <label for="adjustment_type" class="form-label">Typ der Anpassung *</label>
                            <select name="adjustment_type" id="adjustment_type" class="form-select" required>
                                <optgroup label="Abgang">
                                    <option value="eigenentnahme">üè† Eigenentnahme (privat)</option>
                                    <option value="geschenk">üéÅ Geschenk</option>
                                    <option value="verderb">üóëÔ∏è Verderb</option>
                                    <option value="bruch">üí• Bruch/Besch√§digung</option>
                                </optgroup>
                                <optgroup label="Inventur">
                                    <option value="inventur_plus">üìä Inventur-Zugang (mehr als erwartet)</option>
                                    <option value="inventur_minus">üìä Inventur-Abgang (weniger als erwartet)</option>
                                </optgroup>
                                <optgroup label="Sonstige">
                                    <option value="korrektur">‚úèÔ∏è Korrektur (Fehleingabe)</option>
                                    <option value="sonstiges">Sonstiges</option>
                                </optgroup>
                            </select>
                        </div>

                        <!-- Menge -->
                        <div class="mb-3">
                            <label for="quantity" class="form-label">Menge *</label>
                            <input type="number" name="quantity" id="quantity" class="form-control" required
                                   placeholder="Negativ f√ºr Abgang, Positiv f√ºr Zugang" onchange="updatePreview()">
                            <small class="form-text text-muted">
                                Negativ f√ºr Abgang (z.B. -5), Positiv f√ºr Zugang (z.B. +10)
                            </small>
                            <div id="stock-preview" class="mt-2"></div>
                        </div>

                        <!-- Grund -->
                        <div class="mb-3">
                            <label for="reason" class="form-label">Grund / Bemerkung *</label>
                            <textarea name="reason" id="reason" class="form-control" rows="3" required
                                      placeholder="Detaillierte Beschreibung f√ºr die Dokumentation (GoBD-Pflicht)"></textarea>
                            <small class="form-text text-muted">
                                Pflichtfeld f√ºr GoBD-Konformit√§t. Beschreiben Sie den Grund f√ºr die Bestands√§nderung.
                            </small>
                        </div>

                        <!-- Buttons -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('list_stock_adjustments') }}" class="btn btn-secondary">
                                <i class="bi bi-arrow-left"></i> Zur√ºck
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Anpassung erstellen
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Hinweise -->
            <div class="alert alert-warning mt-4">
                <h5>‚ö†Ô∏è Wichtiger Hinweis</h5>
                <ul class="mb-0">
                    <li>Bestandsanpassungen k√∂nnen nicht r√ºckg√§ngig gemacht werden</li>
                    <li>Alle Anpassungen werden vollst√§ndig dokumentiert (GoBD)</li>
                    <li>Bei Eigenentnahmen wird automatisch eine Beleg-Nummer erstellt</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
function updateCurrentStock() {
    const select = document.getElementById('product_id');
    const option = select.options[select.selectedIndex];
    const stock = option.dataset.stock;
    const infoDiv = document.getElementById('current-stock-info');

    if (stock !== undefined) {
        infoDiv.innerHTML = `<div class="alert alert-info mb-0"><strong>Aktueller Bestand:</strong> ${stock} St√ºck</div>`;
        updatePreview();
    } else {
        infoDiv.innerHTML = '';
    }
}

function updatePreview() {
    const select = document.getElementById('product_id');
    const option = select.options[select.selectedIndex];
    const currentStock = parseInt(option.dataset.stock) || 0;
    const quantity = parseInt(document.getElementById('quantity').value) || 0;
    const newStock = currentStock + quantity;
    const previewDiv = document.getElementById('stock-preview');

    if (quantity !== 0 && option.value) {
        let alertClass = 'alert-info';
        let icon = 'üìä';

        if (newStock < 0) {
            alertClass = 'alert-danger';
            icon = '‚ùå';
        } else if (quantity < 0) {
            alertClass = 'alert-warning';
            icon = 'üìâ';
        } else {
            alertClass = 'alert-success';
            icon = 'üìà';
        }

        previewDiv.innerHTML = `
            <div class="alert ${alertClass} mb-0">
                ${icon} <strong>Vorschau:</strong> ${currentStock} ‚Üí ${newStock} St√ºck
                ${quantity > 0 ? `(+${quantity})` : `(${quantity})`}
            </div>
        `;
    } else {
        previewDiv.innerHTML = '';
    }
}
</script>
{% endblock %}
