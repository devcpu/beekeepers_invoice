{% extends 'base.html' %}

{% block title %}Benutzer bearbeiten{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <h1>✏️ Benutzer bearbeiten: {{ user.username }}</h1>
</div>

<form method="POST" action="{{ url_for('edit_user', user_id=user.id) }}">
    <div class="card">
        <h2>Benutzerdaten</h2>
        
        <div class="form-grid">
            <div>
                <label>Benutzername</label>
                <input type="text" value="{{ user.username }}" disabled 
                       style="background: #e9ecef; cursor: not-allowed;">
                <small style="color: #6c757d;">Benutzername kann nicht geändert werden</small>
            </div>
            
            <div>
                <label for="email" class="required">E-Mail</label>
                <input type="email" id="email" name="email" required 
                       value="{{ user.email }}"
                       placeholder="max.mustermann@firma.de">
            </div>
        </div>
        
        <div class="form-grid">
            <div>
                <label for="role" class="required">Rolle</label>
                <select id="role" name="role" required onchange="toggleResellerField()">
                    <option value="cashier" {% if user.role == 'cashier' %}selected{% endif %}>
                        Kassierer (nur Kasse)
                    </option>
                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>
                        Administrator (volle Rechte)
                    </option>
                    <option value="reseller" {% if user.role == 'reseller' %}selected{% endif %}>
                        Reseller (eigener Bestand)
                    </option>
                </select>
            </div>
            
            <div>
                <label for="is_active">
                    <input type="checkbox" id="is_active" name="is_active" 
                           {% if user.is_active %}checked{% endif %}
                           style="width: auto; margin-right: 0.5rem;">
                    Account aktiv
                </label>
                <small style="color: #6c757d; display: block; margin-top: 0.5rem;">
                    Deaktivierte Accounts können sich nicht anmelden
                </small>
            </div>
        </div>
        
        <div>
            <label for="totp_required">
                <input type="checkbox" id="totp_required" name="totp_required" 
                       {% if user.totp_required %}checked{% endif %}
                       style="width: auto; margin-right: 0.5rem;">
                2FA verpflichtend
            </label>
            <small style="color: #6c757d; display: block; margin-top: 0.5rem;">
                Benutzer muss 2FA aktivieren und kann es nicht deaktivieren
            </small>
        </div>
        
        <div id="reseller-field" style="display: {% if user.role == 'reseller' %}block{% else %}none{% endif %};">
            <label for="reseller_customer_id">Zugehöriger Kunde (Reseller)</label>
            <select id="reseller_customer_id" name="reseller_customer_id">
                <option value="">-- Bitte wählen --</option>
                {% for customer in customers %}
                <option value="{{ customer.id }}" 
                        {% if user.reseller_customer_id == customer.id %}selected{% endif %}>
                    {{ customer.company_name or (customer.first_name + ' ' + customer.last_name) }}
                </option>
                {% endfor %}
            </select>
            <small style="color: #6c757d;">Optional: Verknüpfung mit Kundendaten für Kommissionslager</small>
        </div>
    </div>
    
    <div class="card">
        <h2>Passwort ändern</h2>
        <p style="color: #6c757d; margin-bottom: 1.5rem;">Lassen Sie das Feld leer, um das Passwort nicht zu ändern.</p>
        
        <div>
            <label for="new_password">Neues Passwort</label>
            <input type="password" id="new_password" name="new_password" 
                   minlength="8"
                   placeholder="Mindestens 8 Zeichen (optional)">
            <small style="color: #6c757d;">Nur ausfüllen, wenn Sie das Passwort ändern möchten</small>
        </div>
    </div>
    
    <div class="card">
        <h2>Statistiken</h2>
        
        <div style="display: grid; grid-template-columns: 200px 1fr; gap: 1rem;">
            <div><strong>Erstellt am:</strong></div>
            <div>{{ user.created_at.strftime('%d.%m.%Y %H:%M') if user.created_at else 'Unbekannt' }}</div>
            
            <div><strong>Letzter Login:</strong></div>
            <div>
                {% if user.last_login %}
                {{ user.last_login.strftime('%d.%m.%Y %H:%M') }}
                {% if user.last_login_ip %}
                    <span style="color: #6c757d;">({{ user.last_login_ip }})</span>
                {% endif %}
                {% else %}
                <span style="color: #6c757d;">Nie</span>
                {% endif %}
            </div>
            
            <div><strong>2FA Status:</strong></div>
            <div>
                {% if user.totp_enabled %}
                <span style="color: #28a745;">✓ Aktiviert</span>
                {% else %}
                <span style="color: #dc3545;">✗ Nicht aktiviert</span>
                {% endif %}
                {% if user.totp_required %}
                <span style="background: #ff9800; color: white; padding: 0.2rem 0.5rem; border-radius: 3px; font-size: 0.85rem; margin-left: 0.5rem;">
                    Pflicht
                </span>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div style="display: flex; gap: 1rem; margin-top: 2rem;">
        <button type="submit" class="btn" style="background: #007bff; color: white;">
            <i class="bi bi-check-circle"></i> Änderungen speichern
        </button>
        <a href="{{ url_for('list_users') }}" class="btn" style="background: #6c757d; color: white;">
            <i class="bi bi-x-circle"></i> Abbrechen
        </a>
    </div>
</form>

<script>
function toggleResellerField() {
    const role = document.getElementById('role').value;
    const resellerField = document.getElementById('reseller-field');
    resellerField.style.display = role === 'reseller' ? 'block' : 'none';
}
</script>
{% endblock %}
