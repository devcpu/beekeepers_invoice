{% extends 'base.html' %}
{% block title %}Benutzerverwaltung{% endblock %}
{% block content %}
    <div style="display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 2rem">
        <h1>ðŸ‘¥ Benutzerverwaltung</h1>
        <a href="{{ url_for('create_user') }}"
           class="btn"
           style="background: #28a745;
                  color: white">
            <i class="bi bi-person-plus"></i> Neuer Benutzer
        </a>
    </div>
    <div class="card">
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <th style="padding: 1rem; text-align: left;">Benutzername</th>
                    <th style="padding: 1rem; text-align: left;">E-Mail</th>
                    <th style="padding: 1rem; text-align: left;">Rolle</th>
                    <th style="padding: 1rem; text-align: center;">2FA</th>
                    <th style="padding: 1rem; text-align: center;">Status</th>
                    <th style="padding: 1rem; text-align: left;">Letzter Login</th>
                    <th style="padding: 1rem; text-align: right;">Aktionen</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td style="padding: 1rem;">
                            <strong>{{ user.username }}</strong>
                            {% if user.id == current_user.id %}
                                <span style="background: #007bff;
                                             color: white;
                                             padding: 0.2rem 0.5rem;
                                             border-radius: 3px;
                                             font-size: 0.8rem;
                                             margin-left: 0.5rem">Sie</span>
                            {% endif %}
                        </td>
                        <td style="padding: 1rem;">{{ user.email }}</td>
                        <td style="padding: 1rem;">
                            {% if user.role == 'admin' %}
                                <span style="background: #dc3545;
                                             color: white;
                                             padding: 0.3rem 0.6rem;
                                             border-radius: 3px;
                                             font-size: 0.85rem">
                                    <i class="bi bi-shield-fill"></i> Admin
                                </span>
                            {% elif user.role == 'cashier' %}
                                <span style="background: #17a2b8;
                                             color: white;
                                             padding: 0.3rem 0.6rem;
                                             border-radius: 3px;
                                             font-size: 0.85rem">
                                    <i class="bi bi-cash-register"></i> Kassierer
                                </span>
                            {% elif user.role == 'reseller' %}
                                <span style="background: #ffc107;
                                             color: #000;
                                             padding: 0.3rem 0.6rem;
                                             border-radius: 3px;
                                             font-size: 0.85rem">
                                    <i class="bi bi-shop"></i> Reseller
                                </span>
                            {% endif %}
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            {% if user.totp_enabled %}
                                <span style="color: #28a745;" title="2FA aktiviert">
                                    <i class="bi bi-shield-check" style="font-size: 1.3rem;"></i>
                                </span>
                            {% else %}
                                <span style="color: #dc3545;" title="2FA nicht aktiviert">
                                    <i class="bi bi-shield-x" style="font-size: 1.3rem;"></i>
                                </span>
                            {% endif %}
                            {% if user.totp_required %}
                                <br>
                                <span style="background: #ff9800;
                                             color: white;
                                             padding: 0.2rem 0.4rem;
                                             border-radius: 3px;
                                             font-size: 0.75rem;
                                             margin-top: 0.3rem;
                                             display: inline-block"
                                      title="2FA ist Pflicht">Pflicht</span>
                            {% endif %}
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            {% if user.is_active %}
                                <span style="background: #28a745;
                                             color: white;
                                             padding: 0.3rem 0.6rem;
                                             border-radius: 3px;
                                             font-size: 0.85rem">âœ“ Aktiv</span>
                            {% else %}
                                <span style="background: #6c757d;
                                             color: white;
                                             padding: 0.3rem 0.6rem;
                                             border-radius: 3px;
                                             font-size: 0.85rem">âœ— Inaktiv</span>
                            {% endif %}
                        </td>
                        <td style="padding: 1rem;">
                            {% if user.last_login %}
                                {{ user.last_login.strftime("%d.%m.%Y %H:%M") }}
                                {% if user.last_login_ip %}
                                    <br>
                                    <small style="color: #6c757d;">{{ user.last_login_ip }}</small>
                                {% endif %}
                            {% else %}
                                <span style="color: #6c757d;">Nie</span>
                            {% endif %}
                        </td>
                        <td style="padding: 1rem; text-align: right;">
                            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                <a href="{{ url_for('edit_user', user_id=user.id) }}"
                                   class="btn btn-sm"
                                   style="background: #007bff;
                                          color: white;
                                          padding: 0.4rem 0.8rem;
                                          text-decoration: none;
                                          border-radius: 4px"
                                   title="Bearbeiten">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                {% if user.id != current_user.id %}
                                    <form method="POST"
                                          action="{{ url_for('toggle_user_active', user_id=user.id) }}"
                                          style="display: inline">
                                        <button type="submit"
                                                class="btn btn-sm"
                                                style="background: {% if user.is_active %}#ffc107{% else %}#28a745{% endif %};
                                                       color: {% if user.is_active %}#000{% else %}white{% endif %};
                                                       padding: 0.4rem 0.8rem;
                                                       border: none;
                                                       border-radius: 4px;
                                                       cursor: pointer"
                                                title="{% if user.is_active %}Deaktivieren{% else %}Aktivieren{% endif %}">
                                            <i class="bi bi-{% if user.is_active %}pause-circle{% else %}play-circle{% endif %}"></i>
                                        </button>
                                    </form>
                                    {% if user.totp_enabled %}
                                        <form method="POST"
                                              action="{{ url_for('reset_user_2fa', user_id=user.id) }}"
                                              style="display: inline">
                                            <button type="submit"
                                                    class="btn btn-sm"
                                                    style="background: #ff9800;
                                                           color: white;
                                                           padding: 0.4rem 0.8rem;
                                                           border: none;
                                                           border-radius: 4px;
                                                           cursor: pointer"
                                                    title="2FA zurÃ¼cksetzen"
                                                    onclick="return confirm('2FA fÃ¼r {{ user.username }} zurÃ¼cksetzen?')">
                                                <i class="bi bi-arrow-counterclockwise"></i>
                                            </button>
                                        </form>
                                    {% endif %}
                                    <form method="POST"
                                          action="{{ url_for('toggle_user_2fa_required', user_id=user.id) }}"
                                          style="display: inline">
                                        <button type="submit"
                                                class="btn btn-sm"
                                                style="background: {% if user.totp_required %}#6c757d{% else %}#ff9800{% endif %};
                                                       color: white;
                                                       padding: 0.4rem 0.8rem;
                                                       border: none;
                                                       border-radius: 4px;
                                                       cursor: pointer"
                                                title="{% if user.totp_required %}2FA-Pflicht aufheben{% else %}2FA verpflichtend machen{% endif %}">
                                            <i class="bi bi-{% if user.totp_required %}unlock{% else %}lock{% endif %}"></i>
                                        </button>
                                    </form>
                                    <form method="POST"
                                          action="{{ url_for('delete_user', user_id=user.id) }}"
                                          style="display: inline">
                                        <button type="submit"
                                                class="btn btn-sm"
                                                style="background: #dc3545;
                                                       color: white;
                                                       padding: 0.4rem 0.8rem;
                                                       border: none;
                                                       border-radius: 4px;
                                                       cursor: pointer"
                                                title="LÃ¶schen"
                                                onclick="return confirm('Benutzer {{ user.username }} wirklich lÃ¶schen?')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
        {% if users|length == 0 %}
            <div style="padding: 3rem; text-align: center; color: #6c757d;">
                <i class="bi bi-people"
                   style="font-size: 3rem;
                          display: block;
                          margin-bottom: 1rem"></i>
                <p>Keine Benutzer vorhanden.</p>
            </div>
        {% endif %}
    </div>
    <div style="margin-top: 2rem;">
        <a href="{{ url_for('settings') }}"
           class="btn"
           style="background: #6c757d;
                  color: white">
            <i class="bi bi-arrow-left"></i> ZurÃ¼ck zu Einstellungen
        </a>
    </div>
{% endblock %}
